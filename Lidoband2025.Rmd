---
title: "Lidoband 2025"
author: "WAK"
date: "today"
format: 
  html:
    toc: true 
    toc-float: true
    toc-location: left
---

```{r}
#| include: false
#| warning: false
#| echo: false

library(epiDisplay)
library(knitr)
library(pROC)
library(tidyverse)
library(readxl)
library(ggplot2)
library(gmodels)
library(ggbeeswarm)
library(dplyr)
library(ggpubr)
library(psych)
library(lme4)
library(Matrix)
library(lmerTest)
library(irr)
library(emmeans)
library(doBy)       
library(gmodels)    
library(car)           
library(cowplot)       
library(gridGraphics)  
library(multcomp)
library(hms)
library(gt)
library(fuzzyjoin)
library(lubridate)
library(data.table)
library(nlme)
library(lubridate)
```

```{r}
#| include: false
#| warning: false
#| echo: false

lay <- read_csv('data/LyingTLyingB/lyingtime_report_1_ALL.csv')

new <- lay |>
  mutate(
    date = as.Date(Datetime),
    time = hms::as_hms(Datetime)
  )

#remove calf that died
new <-
  new |> 
  filter(Cow != 32)


key<- read_csv("data/calfkey.csv")

key<-key |> 
  filter(Cow != 32) |> 
  mutate(ondate=mdy(ondate), 
         offdate=mdy(offdate)) 


```

```{r}
#| include: false
#| warning: false
#| echo: false

intersect(new$Cow, key$Cow)

combined <- new |> 
  inner_join(key, by = "Cow") 

combinednew <- 
  combined |> 
  mutate(datetime = as.POSIXct(paste(date, time), format = "%Y-%m-%d %H:%M:%S"), 
         datetimeon = as.POSIXct(paste(ondate, ontime), format = "%Y-%m-%d %H:%M:%S"), 
         datetimeoff = as.POSIXct(paste (offdate, offtime), format = "%Y-%m-%d %H:%M:%S"))

use <- combinednew |> 
  filter(datetime >= datetimeon, datetime <= datetimeoff)

setDT(use)
use[, incr := seq_len(.N), by = Cow]

#make a new data frame that only includes what variables I want

use1 <- 
  use |> 
  dplyr::select(Cow, date, time, sday, `Motion Index`, Steps, `Lying Time`, `Lying Bouts`, `Standing Time`, TRT, incr)

use1[, hour := (incr - 1) %/% 4 + 1, by = Cow]
use1[, day := (incr -1)%/% 96+1, by = Cow]
use1[, six := (incr -1)%/% 24+1, by = Cow]
use1[, twelve := (incr -1)%/% 48+1, by = Cow]
use1[, four := (incr -1)%/% 16+1, by = Cow]

```

```{r}
#| include: false
#| warning: false
#| echo: false

#create two new data frames hour and day that include summarized data for those variables

hour <- use1[, .(
  MotionIndex = sum(`Motion Index`),
  Steps = sum(Steps),
  LyingTime = sum(`Lying Time`)/60,
  LyingBouts = sum(`Lying Bouts`),
  StandingTime = sum(`Standing Time`)/60), 
  by = .(Cow, TRT, hour, sday)]

#dividing by 60 results in min

day <- use1[, .(
  MotionIndex = sum(`Motion Index`),
  Steps = sum(Steps),
  LyingTime = sum(`Lying Time`)/3600,
  LyingBouts = sum(`Lying Bouts`),
  StandingTime = sum(`Standing Time`)/3600
), by = .(Cow, TRT, day, sday)]

#divinding by 3600 results in hours

six <- use1[, .(
  MotionIndex = sum(`Motion Index`),
  Steps = sum(Steps),
  LyingTime = sum(`Lying Time`)/3600,
  LyingBouts = sum(`Lying Bouts`),
  StandingTime = sum(`Standing Time`)/3600
), by = .(Cow, TRT, six, sday)]

twelve <- use1[, .(
  MotionIndex = sum(`Motion Index`),
  Steps = sum(Steps),
  LyingTime = sum(`Lying Time`)/3600,
  LyingBouts = sum(`Lying Bouts`),
  StandingTime = sum(`Standing Time`)/3600
), by = .(Cow, TRT, twelve, sday)]


four <- use1[, .(
  MotionIndex = sum(`Motion Index`),
  Steps = sum(Steps),
  LyingTime = sum(`Lying Time`)/3600,
  LyingBouts = sum(`Lying Bouts`),
  StandingTime = sum(`Standing Time`)/3600
), by = .(Cow, TRT, four, sday)]

write.csv(x = day, file = "data/daydatachecks.csv")
```

## Hour Level

### Simple Descriptive Data

```{r}
#| warning: false
#| echo: false

hour |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   sdlying = sd(LyingTime),
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

hour |> 
  ggplot(aes (x = Steps))+
  geom_histogram()

hour |> 
  ggplot(aes (x = LyingTime))+
  geom_histogram()

hour |> 
  ggplot(aes (x = LyingBouts))+
  geom_histogram()

hour |> 
  ggplot(aes (x = StandingTime))+
  geom_histogram()





hour |> 
  group_by(TRT) |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   sdlying = sd(LyingTime),
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

#what if we remove all the data that is >2SD in Lying time from the mean (so calves that had less than 51.1 - 2(11.8) or 23.6 min lying are removed from the data set. How many obs does that get rid of? (n = 5951 -> 5625, remove 326 observations ))

noout2 <- hour |> 
  filter (
    LyingTime > 27.5)

#what about three SDs? 
#How many obs does that get rid of? (n = 5951 -> 5789, remove 162 observations ))
  
noout3 <- hour |> 
  filter(
    LyingTime > 15.7
  )


```

### Plots of Lying Time, Standing Time, Lying Bouts, Steps

```{r}
#| warning: false
#| echo: false



#plot of individal animals with hour
ggplot(hour, aes(x=hour, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()

#plot of individual animals with noout2
ggplot(noout2, aes(x=hour, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()

#plot of individual animals with noout3
ggplot(noout3, aes(x=hour, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


lt_hs <- hour |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_lt = mean (LyingTime, na.rm = TRUE, .groups = "drop"))

ggplot(lt_hs, aes(x=hour, y=m_lt, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Time by Hour and Treatment", 
           x = "Hour", 
           y = "Average Lying Time")+ 
         theme_minimal()




st_hs <- hour |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_st = mean (StandingTime, na.rm = TRUE, .groups = "drop"))

ggplot(st_hs, aes(x=hour, y=m_st, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Standing Time by Hour and Treatment", 
           x = "Hour", 
           y = "Average Standing Time")+ 
         theme_minimal()



lb_hs <- hour |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_lb = mean (LyingBouts, na.rm = TRUE, .groups = "drop"))

ggplot(lb_hs, aes(x=hour, y=m_lb, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Bouts by Hour and Treatment", 
           x = "Hour", 
           y = "Average Lying Bouts")+ 
         theme_minimal()


step_hs <- hour |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_step = mean (Steps, na.rm = TRUE, .groups = "drop"))

ggplot(step_hs, aes(x=hour, y=m_step, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Steps by Hour and Treatment", 
           x = "Hour", 
           y = "Average Steps")+ 
         theme_minimal()



```

### Remove Outliers

(n=10 calves with wonky lying times on d1 and d2 \> 2SD away from the mean). But some of those seemed legit (no long uninterrupted times when they were standing).

```{r}
#| warning: false
#| echo: false

hourrm <-
  hour |> 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83)))

#from 5951 to 5569 (6.8% of data removed 6/93 calves)

lt_hs <- hourrm |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_lt = mean (LyingTime, na.rm = TRUE, .groups = "drop"))

ggplot(lt_hs, aes(x=hour, y=m_lt, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Time by Hour and Treatment", 
           x = "Hour", 
           y = "Average Lying Time")+ 
         theme_minimal()




st_hs <- hourrm |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_st = mean (StandingTime, na.rm = TRUE, .groups = "drop"))

ggplot(st_hs, aes(x=hour, y=m_st, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Standing Time by Hour and Treatment", 
           x = "Hour", 
           y = "Average Standing Time")+ 
         theme_minimal()



lb_hs <- hourrm |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_lb = mean (LyingBouts, na.rm = TRUE, .groups = "drop"))

ggplot(lb_hs, aes(x=hour, y=m_lb, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Bouts by Hour and Treatment", 
           x = "Hour", 
           y = "Average Lying Bouts")+ 
         theme_minimal()


step_hs <- hourrm |> 
  filter(hour<= 60) |> 
  group_by (TRT, hour) |> 
  summarize (m_step = mean (Steps, na.rm = TRUE, .groups = "drop"))

ggplot(step_hs, aes(x=hour, y=m_step, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Steps by Hour and Treatment", 
           x = "Hour", 
           y = "Average Steps")+ 
         theme_minimal()



```

### Models - outliers removed

#### Lying Time

```{r}
#| warning: false
#| echo: false

hourrm <-
  hour |> 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83))) %>% 
  filter(hour<61)


hourrm$hour <- factor(hourrm$hour, levels = unique(hourrm$hour))  # if already time-ordered
hourrm$TimeNum <- as.numeric(hourrm$hour)


mod_base <- lme(
  fixed = LyingTime ~ hour * TRT,
  random = ~ 1 | Cow,
  data = hourrm
)

mod_ar1 <- lme(
  fixed = LyingTime ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)

mod_rs <- lme(
  fixed = LyingTime ~ hour * TRT,
  random = ~ TimeNum | Cow,
  data = hourrm
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit, but it's not great



mod_ar1 <- lme(
  fixed = LyingTime ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)
summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * hour)
summary(emm)
pairs(emm, by = "TRT")

emm_df <- as.data.frame(emm)

custom_colors <- c("BO" = "red4", "B+N" = "goldenrod2", "LIDO" = "wheat")
ggplot(emm_df, aes(x = hour, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Hour from Banding",
    y = "Estimated Marginal Means of Lying Time") +
  theme_classic()+
  scale_y_continuous(limits = c(0, 70), breaks = seq(0, 70, by = 10))+
  scale_x_discrete(breaks = seq(0, 60, by = 4))

```

#### Standing Time

```{r}
#| warning: false
#| echo: false

hourrm <-
  hour |> 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83))) %>% 
  filter(hour<61)


hourrm$hour <- factor(hourrm$hour, levels = unique(hourrm$hour))  # if already time-ordered
hourrm$TimeNum <- as.numeric(hourrm$hour)


mod_base <- lme(
  fixed = StandingTime ~ hour * TRT,
  random = ~ 1 | Cow,
  data = hourrm
)

mod_ar1 <- lme(
  fixed = StandingTime ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)

mod_rs <- lme(
  fixed = StandingTime ~ hour * TRT,
  random = ~ TimeNum | Cow,
  data = hourrm
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit, but it's not great



mod_ar1 <- lme(
  fixed = StandingTime ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)
summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * hour)
summary(emm)
pairs(emm, by = "TRT")
pairs(emm, by = "hour")

emm_df <- as.data.frame(emm)

custom_colors <- c("BO" = "red4", "B+N" = "goldenrod2", "LIDO" = "wheat")
ggplot(emm_df, aes(x = hour, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Hour from Banding",
    y = "Estimated Marginal Means of Standing Time") +
  theme_classic()+
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by =5))+
  scale_x_discrete(breaks = seq(0, 60, by = 4))

```

#### Lying Bouts

```{r}
#| warning: false
#| echo: false

hourrm <-
  hour |> 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83))) %>% 
  filter(hour<61)


hourrm$hour <- factor(hourrm$hour, levels = unique(hourrm$hour))  # if already time-ordered
hourrm$TimeNum <- as.numeric(hourrm$hour)


mod_base <- lme(
  fixed = LyingBouts ~ hour * TRT,
  random = ~ 1 | Cow,
  data = hourrm
)

mod_ar1 <- lme(
  fixed = LyingBouts ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)

mod_rs <- lme(
  fixed = LyingBouts ~ hour * TRT,
  random = ~ TimeNum | Cow,
  data = hourrm
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit, but it's not great



mod_ar1 <- lme(
  fixed = LyingBouts ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)
summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * hour)
summary(emm)
pairs(emm, by = "TRT")
pairs (emm, by = "hour")

emm_df <- as.data.frame(emm)

custom_colors <- c("BO" = "red4", "B+N" = "goldenrod2", "LIDO" = "wheat")
ggplot(emm_df, aes(x = hour, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Hour from Banding",
    y = "Estimated Marginal Means of LB") +
  theme_classic()+
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, by =1))+
  scale_x_discrete(breaks = seq(0, 60, by = 4))

```

#### Steps

```{r}
#| warning: false
#| echo: false

hourrm <-
  hour |> 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83))) %>% 
  filter(hour<61)


hourrm$hour <- factor(hourrm$hour, levels = unique(hourrm$hour))  # if already time-ordered
hourrm$TimeNum <- as.numeric(hourrm$hour)


mod_base <- lme(
  fixed = Steps ~ hour * TRT,
  random = ~ 1 | Cow,
  data = hourrm
)

mod_ar1 <- lme(
  fixed = Steps ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)

mod_rs <- lme(
  fixed = Steps ~ hour * TRT,
  random = ~ TimeNum | Cow,
  data = hourrm
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit, but it's not great



mod_ar1 <- lme(
  fixed = Steps ~ hour * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = hourrm
)
summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * hour)
emmeans(mod_ar1, ~ TRT*hour)
emmeans(mod_ar1, ~ TRT)
summary(emm)
pairs(emm, by = "TRT")
pairs(emm, by = "hour")

emm_df <- as.data.frame(emm)

custom_colors <- c("BO" = "red4", "B+N" = "goldenrod2", "LIDO" = "wheat")
ggplot(emm_df, aes(x = hour, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Hour from Banding",
    y = "Estimated Marginal Means of Steps") +
  theme_classic()+
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, by =5))+
  scale_x_discrete(breaks = seq(0, 60, by = 4))

```

## Four Hour Level

### Simple Description

```{r}
#|warning: false
#|echo: false

four |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

four |> 
  group_by(TRT) |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

```

### Plots of Lying Time, Standing Time, Lying Bouts, Steps

```{r}

#plot of individal animals
ggplot(four, aes(x=four, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


lt_four <- four |> 
  filter(four<16) |> 
  group_by (TRT, four) |> 
  summarize (m_lt = mean (LyingTime, na.rm = TRUE, .groups = "drop"))

ggplot(lt_four, aes(x=four, y=m_lt, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Time by Four Hour Increment and Treatment", 
           x = "Four Hour Increment", 
           y = "Average Lying Time(h)")+
      scale_x_continuous(limits = c(0, 16), breaks = seq(0, 16, by = 1))+
      scale_y_continuous(limits = c(2, 5), breaks = seq(2, 5, by = 0.5)) +
  theme_classic()




st_four <- four|> 
  filter(four< 16) |> 
  group_by (TRT, four) |> 
  summarize (m_st = mean (StandingTime, na.rm = TRUE, .groups = "drop"))

ggplot(st_four, aes(x=four, y=m_st, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Standing Time by Four Hour Increment and Treatment", 
           x = "Four Hour Increment", 
           y = "Average Standing Time")+
      scale_x_continuous(limits = c(0, 16), breaks = seq(0, 16, by = 1))+
      scale_y_continuous(limits = c(0, 2), breaks = seq(0, 2, by = 0.5)) +
  theme_classic()
        



lb_four <- four|> 
  filter(four< 16) |> 
  group_by (TRT, four) |> 
  summarize (m_lb = mean (LyingBouts, na.rm = TRUE, .groups = "drop"))

ggplot(lb_four, aes(x=four, y=m_lb, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Bouts by Hour and Treatment", 
           x = "Four Hour Increment", 
           y = "Average Lying Bouts")+ 
      scale_x_continuous(limits = c(0, 16), breaks = seq(0, 16, by = 1))+
      scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 1)) +
  theme_classic()
      


step_four <- four |> 
  filter(four< 16) |> 
  group_by (TRT, four) |> 
  summarize (m_step = mean (Steps, na.rm = TRUE, .groups = "drop"))

ggplot(step_four, aes(x=four, y=m_step, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Steps by Hour and Treatment", 
           x = "Four Hour Increment", 
           y = "Average Steps")+ 
      scale_y_continuous(limits = c(0, 125), breaks = seq(0, 125, by = 25))+
      scale_x_continuous(limits = c(0, 16), breaks = seq(0, 16, by = 1)) +
         theme_classic()


```

## Six Hour Level (Other increment?)

### Simple Description

```{r}
#|warning: false
#|echo: false

six |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

six |> 
  group_by(TRT) |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )





```

### Plots of Lying Time, Standing Time, Lying Bouts, Steps

```{r}

#plot of individal animals
ggplot(six, aes(x=six, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()




lt_six <- six |> 
  filter (six<=10) |> 
  group_by (TRT, six) |> 
  summarize (m_lt = mean (LyingTime, na.rm = TRUE, .groups = "drop"))

ggplot(lt_six, aes(x=six, y=m_lt, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Time by Six Hour Increment and Treatment", 
           x = "Hour", 
           y = "Average Lying Time(h)") + 
         theme_minimal()




st_six <- six |> 
  filter(six<= 10) |> 
  group_by (TRT, six) |> 
  summarize (m_st = mean (StandingTime, na.rm = TRUE, .groups = "drop"))

ggplot(st_six, aes(x=six, y=m_st, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Standing Time by Six Hour Increment and Treatment", 
           x = "Hour", 
           y = "Average Standing Time")+ 
         theme_minimal()



lb_six <- six |> 
  filter(six<= 10) |> 
  group_by (TRT, six) |> 
  summarize (m_lb = mean (LyingBouts, na.rm = TRUE, .groups = "drop"))

ggplot(lb_six, aes(x=six, y=m_lb, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Bouts by Hour and Treatment", 
           x = "Hour", 
           y = "Average Lying Bouts")+ 
         theme_minimal()


step_six <- six |> 
  filter(six<= 10) |> 
  group_by (TRT, six) |> 
  summarize (m_step = mean (Steps, na.rm = TRUE, .groups = "drop"))

ggplot(step_six, aes(x=six, y=m_step, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Steps by Hour and Treatment", 
           x = "Hour", 
           y = "Average Steps")+ 
         theme_minimal()


```

## Twelve Hour Level

### Simple Descriptive Data

```{r}
#|warning: false
#|echo: false

twelve |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

twelve |> 
  group_by(TRT) |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )


```

### Plots of Lying Time, Standing Time, Lying Bouts, Steps

```{r}
#|warning: false
#|echo: false


#plot of individal animals
ggplot(twelve, aes(x=twelve, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


lt_12 <- twelve |> 
  filter (twelve<6) |> 
  group_by (TRT, twelve) |> 
  summarize (m_lt = mean (LyingTime, na.rm = TRUE, .groups = "drop"))

ggplot(lt_12, aes(x=twelve, y=m_lt, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Time by 12 Hour Increment and Treatment", 
           x = "Hour", 
           y = "Average Lying Time(h)") + 
         theme_minimal()




st_12 <- twelve |> 
  filter(twelve< 6) |> 
  group_by (TRT, twelve) |> 
  summarize (m_st = mean (StandingTime, na.rm = TRUE, .groups = "drop"))

ggplot(st_12, aes(x=twelve, y=m_st, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Standing Time by Six Hour Increment and Treatment", 
           x = "Hour", 
           y = "Average Standing Time")+ 
         theme_minimal()



lb_12 <- twelve |> 
  filter(twelve<6) |> 
  group_by (TRT, twelve) |> 
  summarize (m_lb = mean (LyingBouts, na.rm = TRUE, .groups = "drop"))

ggplot(lb_12, aes(x=twelve, y=m_lb, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Lying Bouts by Hour and Treatment", 
           x = "Hour", 
           y = "Average Lying Bouts")+ 
         theme_minimal()


step_12 <- twelve |> 
  filter(twelve<6) |> 
  group_by (TRT, twelve) |> 
  summarize (m_step = mean (Steps, na.rm = TRUE, .groups = "drop"))

ggplot(step_12, aes(x=twelve, y=m_step, color = TRT))+
         geom_line (size = 1)+
         geom_point()+
         labs (
           title = "Average Steps by Hour and Treatment", 
           x = "Hour", 
           y = "Average Steps")+ 
         theme_minimal()


```

## Day Level

### Simple Descriptive Data

```{r}
#| warning: false
#| echo: false

day |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime),
   sdlay = sd (LyingTime),
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

day |> 
  group_by(TRT) |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

day |> 
  group_by(TRT, day) |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   lb = mean (LyingBouts),
   stand = mean (StandingTime)
  )

day |> 
  group_by(day) |> 
  summarize (
   motion = mean (MotionIndex), 
   steps = mean (Steps), 
   lying = mean (LyingTime), 
   sdlie = sd(LyingTime),
   lb = mean (LyingBouts),
   stand = mean (StandingTime),
   standsd = sd(StandingTime)
  )

```

### Plots of Lying Time, Standing Time, Lying Bouts, Steps

```{r}
#| warning: false
#| echo: false

#plot of individal animals
ggplot(day, aes(x=day, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()
#who were those calves who had low lying time on day 2? Thought at first it was the calf that died, but that doesn't seem to be the case as I filtered him out. Then all seeded to behave similarly on day 3(only like 12h of data represented). Individual vaiation, pain, sensor placement/position, loose calves?

#REMOVE THOSE CALVES:
dayrm <-
  day |> 
  filter(! (Cow %in% c(11, 20, 54, 57, 58, 62, 64, 65, 78, 83)))

ggplot(dayrm, aes(x=day, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()

dayrm2<- 
  day %>% 
filter(! (Cow %in% c(11, 20, 54, 57, 64, 83)))

ggplot(dayrm2, aes(x=day, y=LyingTime, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


#box plots for days 1 and 2 (24, and 48hrs post banding)

day2only <- dayrm2 |> 
  filter (day < 3)

#standing time
day2only |> 
  ggplot(mapping = aes(x = TRT, y = StandingTime, color=TRT)) +
  theme_classic()+
  geom_boxplot(outlier.color = "black") +
  geom_jitter(width = 0.2, alpha = 0.6)+
  facet_wrap(~day)+
   labs( title = "Average Standing Time (h) by day and Treatment", 
           x = "", 
           y = "Standing Time (h)")

day2only %>% 
ggplot(aes(x=day, y=StandingTime, color = TRT))+
         geom_line (size = 1)+
         labs (
           title = "Average Standing Time by Hour and Treatment", 
           x = "Hour", 
           y = "Average Standing Time")+ 
         theme_minimal()


#lying time
day2only |> 
  ggplot(mapping = aes(x = TRT, y = LyingTime, color=TRT)) +
  theme_classic()+
  geom_boxplot(outlier.color = "black") +
  geom_jitter(width = 0.2, alpha = 0.6)+
  facet_wrap(~day)+ 
  labs( title = "Average Lying Time (h) by day and Treatment", 
           x = "", 
           y = "Lying Time (h)")
 

day2only %>% 
ggplot(aes(x=day, y=LyingTime, color = TRT))+
         geom_line (size = 1)+
         labs (
           title = "Average Lying Time by day and Treatment", 
           x = "", 
           y = "Average Lying Time")+ 
         theme_minimal()   

#lying bouts
day2only |> 
  ggplot(mapping = aes(x = TRT, y = LyingBouts, color=TRT)) +
  theme_classic()+
  geom_boxplot(outlier.color = "black") +
  geom_jitter(width = 0.2, alpha = 0.6)+
  facet_wrap(~day)+ 
  labs( title = "Average Lying Bouts by day and Treatment", 
           x = "", 
           y = "Lying Bouts (n)")

day2only %>% 
ggplot(aes(x=day, y=LyingBouts, color = TRT))+
         geom_line (size = 1)+
         labs (
           title = "Average LB by day and Treatment", 
           x = "", 
           y = "Average LB")+ 
         theme_minimal()   



#steps
day2only |> 
  ggplot(mapping = aes(x = TRT, y = Steps, color=TRT)) +
  theme_classic()+
  geom_boxplot(outlier.color = "black") +
  geom_jitter(width = 0.2, alpha = 0.6)+
  facet_wrap(~day)+ 
  labs( title = "Average Steps by day and Treatment", 
           x = "", 
           y = "Steps (n)")

day2only %>% 
ggplot(aes(x=day, y=Steps, color = TRT))+
         geom_line (size = 1)+
         labs (
           title = "Average Steps by day and Treatment", 
           x = "", 
           y = "Average Steps")+ 
         theme_minimal()   

```

## Models - 4 Hour

### Lying Time

```{r}
fourmodel <- four |> 
  filter(four<16) %>% 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83)))

fourmodel$four <- factor(fourmodel$four, levels = unique(fourmodel$four))  # if already time-ordered
fourmodel$TimeNum <- as.numeric(fourmodel$four)


mod_base <- lme(
  fixed = LyingTime ~ four * TRT,
  random = ~ 1 | Cow,
  data = fourmodel
)

mod_ar1 <- lme(
  fixed = LyingTime ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)

mod_rs <- lme(
  fixed = LyingTime ~ four * TRT,
  random = ~ TimeNum | Cow,
  data = fourmodel
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit



mod_ar1 <- lme(
  fixed = LyingTime ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)
summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * four)
summary(emm)
pairs(emm, by = "four")
pairs(emm, by = "TRT")

emm_df <- as.data.frame(emm)

ggplot(emm_df, aes(x = four, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Time (four)",
    y = "Estimated Marginal Means of Lying Time",
    title = "Model-Adjusted Means by Treatment and Time"
  ) +
  theme_classic()



```

### Standing Time

```{r}
fourmodel <- four |> 
  filter(four<16) %>% 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83)))

fourmodel$four <- factor(fourmodel$four, levels = unique(fourmodel$four))  # if already time-ordered
fourmodel$TimeNum <- as.numeric(fourmodel$four)


mod_base <- lme(
  fixed = StandingTime ~ four * TRT,
  random = ~ 1 | Cow,
  data = fourmodel
)


mod_ar1 <- lme(
  fixed = StandingTime ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)

mod_rs <- lme(
  fixed = StandingTime ~ four * TRT,
  random = ~ TimeNum | Cow,
  data = fourmodel
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit



mod_ar1 <- lme(
  fixed = StandingTime ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)

summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * four)
summary(emm)
pairs(emm, by = "four")
pairs(emm, by = "TRT")

emm_df <- as.data.frame(emm)

ggplot(emm_df, aes(x = four, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Time (four)",
    y = "Estimated Marginal Means of Standing Time",
    title = "Model-Adjusted Means by Treatment and Time"
  ) +
  theme_classic()



```

### Lying Bouts

```{r}
fourmodel <- four |> 
  filter(four<16) %>% 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83)))

fourmodel$four <- factor(fourmodel$four, levels = unique(fourmodel$four))  # if already time-ordered
fourmodel$TimeNum <- as.numeric(fourmodel$four)


mod_base <- lme(
  fixed = LyingBouts ~ four * TRT,
  random = ~ 1 | Cow,
  data = fourmodel
)


mod_ar1 <- lme(
  fixed = LyingBouts ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)

mod_rs <- lme(
  fixed = LyingBouts ~ four * TRT,
  random = ~ TimeNum | Cow,
  data = fourmodel
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit



mod_ar1 <- lme(
  fixed = LyingBouts ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)
summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * four)
summary(emm)
pairs(emm, by = "four")
pairs(emm, by = "TRT", adjust="tukey")

emm_df <- as.data.frame(emm)

ggplot(emm_df, aes(x = four, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Time (four)",
    y = "Estimated Marginal Means of Lying Bouts",
    title = "Model-Adjusted Means by Treatment and Time"
  ) +
  theme_classic()



```

### Steps

```{r}
fourmodel <- four |> 
  filter(four<16) %>% 
  filter(! (Cow %in% c(11, 20, 54, 57, 64, 83)))

fourmodel$four <- factor(fourmodel$four, levels = unique(fourmodel$four))  # if already time-ordered
fourmodel$TimeNum <- as.numeric(fourmodel$four)


mod_base <- lme(
  fixed = Steps ~ four * TRT,
  random = ~ 1 | Cow,
  data = fourmodel
)


mod_ar1 <- lme(
  fixed = Steps ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)

mod_rs <- lme(
  fixed = Steps ~ four * TRT,
  random = ~ TimeNum | Cow,
  data = fourmodel
)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)

#AR1 is the best model based on fit



mod_ar1 <- lme(
  fixed = Steps ~ four * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ TimeNum | Cow),
  data = fourmodel
)
summary(mod_ar1)
car::Anova(mod_ar1, type=3)

emm <- emmeans(mod_ar1, ~ TRT * four)
summary(emm)
pairs(emm, by = "four")
pairs(emm, by = "TRT", adjust="tukey")

emm_df <- as.data.frame(emm)

ggplot(emm_df, aes(x = four, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(
    x = "Time (four)",
    y = "Estimated Marginal Means of Lying Bouts",
    title = "Model-Adjusted Means by Treatment and Time"
  ) +
  theme_classic()
```

Not sure what to do about increment. I like using the hour increment as it shows WHEN calves are doing stuff and also highlights feeding times (Sat and Sun). Maybe ask Elise what she thinks about how to best analyze and represent this data? Doesn't really look like there is a difference in standing or lying, but there is a differene in LB and Steps (for sure) which is interesting. I think use Hour. Can give daily average if needed? But like the hour level data for its' extra invormation (partiularly around feeding time).
